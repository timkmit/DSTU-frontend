var Re=Object.defineProperty;var Ee=(p,o,n)=>o in p?Re(p,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):p[o]=n;var ee=(p,o,n)=>(Ee(p,typeof o!="symbol"?o+"":o,n),n);import{r as Ne,R as de,j as t,a as I,T as E,c as Fe,P as D,L as ae,B as re}from"./index-B9-aZz-R.js";import{u as _e,B as Be}from"./analysis.api-Bz0JSCEP.js";import{a as ke}from"./event.api-Myid_Vzp.js";import{u as Oe}from"./useAppSelector-BTsF-SKP.js";import{T as Z}from"./TextField-CG6ONMtj.js";import{S as he}from"./Stars-BFtIPY_r.js";const Ae=Ne.injectEndpoints({endpoints:p=>({addEventReview:p.mutation({query:({city:o,...n})=>({method:"POST",url:`/review_event?city=${o}`,body:n})}),addSubjectReview:p.mutation({query:o=>({method:"POST",url:"/add_review",body:o})})})}),{useAddEventReviewMutation:Le,useAddSubjectReviewMutation:aa}=Ae;var ne={};(function p(o,n,m,b){var P=!!(o.Worker&&o.Blob&&o.Promise&&o.OffscreenCanvas&&o.OffscreenCanvasRenderingContext2D&&o.HTMLCanvasElement&&o.HTMLCanvasElement.prototype.transferControlToOffscreen&&o.URL&&o.URL.createObjectURL),N=typeof Path2D=="function"&&typeof DOMMatrix=="function",w=function(){if(!o.OffscreenCanvas)return!1;var a=new OffscreenCanvas(1,1),e=a.getContext("2d");e.fillRect(0,0,1,1);var r=a.transferToImageBitmap();try{e.createPattern(r,"no-repeat")}catch{return!1}return!0}();function k(){}function W(a){var e=n.exports.Promise,r=e!==void 0?e:o.Promise;return typeof r=="function"?new r(a):(a(k,k),null)}var z=function(a,e){return{transform:function(r){if(a)return r;if(e.has(r))return e.get(r);var i=new OffscreenCanvas(r.width,r.height),l=i.getContext("2d");return l.drawImage(r,0,0),e.set(r,i),i},clear:function(){e.clear()}}}(w,new Map),A=function(){var a=Math.floor(16.666666666666668),e,r,i={},l=0;return typeof requestAnimationFrame=="function"&&typeof cancelAnimationFrame=="function"?(e=function(c){var u=Math.random();return i[u]=requestAnimationFrame(function s(d){l===d||l+a-1<d?(l=d,delete i[u],c()):i[u]=requestAnimationFrame(s)}),u},r=function(c){i[c]&&cancelAnimationFrame(i[c])}):(e=function(c){return setTimeout(c,a)},r=function(c){return clearTimeout(c)}),{frame:e,cancel:r}}(),F=function(){var a,e,r={};function i(l){function c(u,s){l.postMessage({options:u||{},callback:s})}l.init=function(s){var d=s.transferControlToOffscreen();l.postMessage({canvas:d},[d])},l.fire=function(s,d,v){if(e)return c(s,null),e;var x=Math.random().toString(36).slice(2);return e=W(function(g){function M(C){C.data.callback===x&&(delete r[x],l.removeEventListener("message",M),e=null,z.clear(),v(),g())}l.addEventListener("message",M),c(s,x),r[x]=M.bind(null,{data:{callback:x}})}),e},l.reset=function(){l.postMessage({reset:!0});for(var s in r)r[s](),delete r[s]}}return function(){if(a)return a;if(!m&&P){var l=["var CONFETTI, SIZE = {}, module = {};","("+p.toString()+")(this, module, true, SIZE);","onmessage = function(msg) {","  if (msg.data.options) {","    CONFETTI(msg.data.options).then(function () {","      if (msg.data.callback) {","        postMessage({ callback: msg.data.callback });","      }","    });","  } else if (msg.data.reset) {","    CONFETTI && CONFETTI.reset();","  } else if (msg.data.resize) {","    SIZE.width = msg.data.resize.width;","    SIZE.height = msg.data.resize.height;","  } else if (msg.data.canvas) {","    SIZE.width = msg.data.canvas.width;","    SIZE.height = msg.data.canvas.height;","    CONFETTI = module.exports.create(msg.data.canvas);","  }","}"].join(`
`);try{a=new Worker(URL.createObjectURL(new Blob([l])))}catch(c){return typeof console!==void 0&&typeof console.warn=="function"&&console.warn("🎊 Could not load worker",c),null}i(a)}return a}}(),_={particleCount:50,angle:90,spread:45,startVelocity:45,decay:.9,gravity:1,drift:0,ticks:200,x:.5,y:.5,shapes:["square","circle"],zIndex:100,colors:["#26ccff","#a25afd","#ff5e7e","#88ff5a","#fcff42","#ffa62d","#ff36ff"],disableForReducedMotion:!1,scalar:1};function H(a,e){return e?e(a):a}function G(a){return a!=null}function y(a,e,r){return H(a&&G(a[e])?a[e]:_[e],r)}function Q(a){return a<0?0:Math.floor(a)}function $(a,e){return Math.floor(Math.random()*(e-a))+a}function U(a){return parseInt(a,16)}function J(a){return a.map(K)}function K(a){var e=String(a).replace(/[^0-9a-f]/gi,"");return e.length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),{r:U(e.substring(0,2)),g:U(e.substring(2,4)),b:U(e.substring(4,6))}}function q(a){var e=y(a,"origin",Object);return e.x=y(e,"x",Number),e.y=y(e,"y",Number),e}function V(a){a.width=document.documentElement.clientWidth,a.height=document.documentElement.clientHeight}function f(a){var e=a.getBoundingClientRect();a.width=e.width,a.height=e.height}function T(a){var e=document.createElement("canvas");return e.style.position="fixed",e.style.top="0px",e.style.left="0px",e.style.pointerEvents="none",e.style.zIndex=a,e}function me(a,e,r,i,l,c,u,s,d){a.save(),a.translate(e,r),a.rotate(c),a.scale(i,l),a.arc(0,0,1,u,s,d),a.restore()}function ve(a){var e=a.angle*(Math.PI/180),r=a.spread*(Math.PI/180);return{x:a.x,y:a.y,wobble:Math.random()*10,wobbleSpeed:Math.min(.11,Math.random()*.1+.05),velocity:a.startVelocity*.5+Math.random()*a.startVelocity,angle2D:-e+(.5*r-Math.random()*r),tiltAngle:(Math.random()*(.75-.25)+.25)*Math.PI,color:a.color,shape:a.shape,tick:0,totalTicks:a.ticks,decay:a.decay,drift:a.drift,random:Math.random()+2,tiltSin:0,tiltCos:0,wobbleX:0,wobbleY:0,gravity:a.gravity*3,ovalScalar:.6,scalar:a.scalar,flat:a.flat}}function ge(a,e){e.x+=Math.cos(e.angle2D)*e.velocity+e.drift,e.y+=Math.sin(e.angle2D)*e.velocity+e.gravity,e.velocity*=e.decay,e.flat?(e.wobble=0,e.wobbleX=e.x+10*e.scalar,e.wobbleY=e.y+10*e.scalar,e.tiltSin=0,e.tiltCos=0,e.random=1):(e.wobble+=e.wobbleSpeed,e.wobbleX=e.x+10*e.scalar*Math.cos(e.wobble),e.wobbleY=e.y+10*e.scalar*Math.sin(e.wobble),e.tiltAngle+=.1,e.tiltSin=Math.sin(e.tiltAngle),e.tiltCos=Math.cos(e.tiltAngle),e.random=Math.random()+2);var r=e.tick++/e.totalTicks,i=e.x+e.random*e.tiltCos,l=e.y+e.random*e.tiltSin,c=e.wobbleX+e.random*e.tiltCos,u=e.wobbleY+e.random*e.tiltSin;if(a.fillStyle="rgba("+e.color.r+", "+e.color.g+", "+e.color.b+", "+(1-r)+")",a.beginPath(),N&&e.shape.type==="path"&&typeof e.shape.path=="string"&&Array.isArray(e.shape.matrix))a.fill(ye(e.shape.path,e.shape.matrix,e.x,e.y,Math.abs(c-i)*.1,Math.abs(u-l)*.1,Math.PI/10*e.wobble));else if(e.shape.type==="bitmap"){var s=Math.PI/10*e.wobble,d=Math.abs(c-i)*.1,v=Math.abs(u-l)*.1,x=e.shape.bitmap.width*e.scalar,g=e.shape.bitmap.height*e.scalar,M=new DOMMatrix([Math.cos(s)*d,Math.sin(s)*d,-Math.sin(s)*v,Math.cos(s)*v,e.x,e.y]);M.multiplySelf(new DOMMatrix(e.shape.matrix));var C=a.createPattern(z.transform(e.shape.bitmap),"no-repeat");C.setTransform(M),a.globalAlpha=1-r,a.fillStyle=C,a.fillRect(e.x-x/2,e.y-g/2,x,g),a.globalAlpha=1}else if(e.shape==="circle")a.ellipse?a.ellipse(e.x,e.y,Math.abs(c-i)*e.ovalScalar,Math.abs(u-l)*e.ovalScalar,Math.PI/10*e.wobble,0,2*Math.PI):me(a,e.x,e.y,Math.abs(c-i)*e.ovalScalar,Math.abs(u-l)*e.ovalScalar,Math.PI/10*e.wobble,0,2*Math.PI);else if(e.shape==="star")for(var h=Math.PI/2*3,j=4*e.scalar,S=8*e.scalar,R=e.x,O=e.y,L=5,B=Math.PI/L;L--;)R=e.x+Math.cos(h)*S,O=e.y+Math.sin(h)*S,a.lineTo(R,O),h+=B,R=e.x+Math.cos(h)*j,O=e.y+Math.sin(h)*j,a.lineTo(R,O),h+=B;else a.moveTo(Math.floor(e.x),Math.floor(e.y)),a.lineTo(Math.floor(e.wobbleX),Math.floor(l)),a.lineTo(Math.floor(c),Math.floor(u)),a.lineTo(Math.floor(i),Math.floor(e.wobbleY));return a.closePath(),a.fill(),e.tick<e.totalTicks}function pe(a,e,r,i,l){var c=e.slice(),u=a.getContext("2d"),s,d,v=W(function(x){function g(){s=d=null,u.clearRect(0,0,i.width,i.height),z.clear(),l(),x()}function M(){m&&!(i.width===b.width&&i.height===b.height)&&(i.width=a.width=b.width,i.height=a.height=b.height),!i.width&&!i.height&&(r(a),i.width=a.width,i.height=a.height),u.clearRect(0,0,i.width,i.height),c=c.filter(function(C){return ge(u,C)}),c.length?s=A.frame(M):g()}s=A.frame(M),d=g});return{addFettis:function(x){return c=c.concat(x),v},canvas:a,promise:v,reset:function(){s&&A.cancel(s),d&&d()}}}function se(a,e){var r=!a,i=!!y(e||{},"resize"),l=!1,c=y(e,"disableForReducedMotion",Boolean),u=P&&!!y(e||{},"useWorker"),s=u?F():null,d=r?V:f,v=a&&s?!!a.__confetti_initialized:!1,x=typeof matchMedia=="function"&&matchMedia("(prefers-reduced-motion)").matches,g;function M(h,j,S){for(var R=y(h,"particleCount",Q),O=y(h,"angle",Number),L=y(h,"spread",Number),B=y(h,"startVelocity",Number),be=y(h,"decay",Number),Ce=y(h,"gravity",Number),we=y(h,"drift",Number),oe=y(h,"colors",J),je=y(h,"ticks",Number),le=y(h,"shapes"),Te=y(h,"scalar"),Pe=!!y(h,"flat"),ce=q(h),ue=R,Y=[],Ie=a.width*ce.x,Se=a.height*ce.y;ue--;)Y.push(ve({x:Ie,y:Se,angle:O,spread:L,startVelocity:B,color:oe[ue%oe.length],shape:le[$(0,le.length)],ticks:je,decay:be,gravity:Ce,drift:we,scalar:Te,flat:Pe}));return g?g.addFettis(Y):(g=pe(a,Y,d,j,S),g.promise)}function C(h){var j=c||y(h,"disableForReducedMotion",Boolean),S=y(h,"zIndex",Number);if(j&&x)return W(function(B){B()});r&&g?a=g.canvas:r&&!a&&(a=T(S),document.body.appendChild(a)),i&&!v&&d(a);var R={width:a.width,height:a.height};s&&!v&&s.init(a),v=!0,s&&(a.__confetti_initialized=!0);function O(){if(s){var B={getBoundingClientRect:function(){if(!r)return a.getBoundingClientRect()}};d(B),s.postMessage({resize:{width:B.width,height:B.height}});return}R.width=R.height=null}function L(){g=null,i&&(l=!1,o.removeEventListener("resize",O)),r&&a&&(document.body.contains(a)&&document.body.removeChild(a),a=null,v=!1)}return i&&!l&&(l=!0,o.addEventListener("resize",O,!1)),s?s.fire(h,R,L):M(h,R,L)}return C.reset=function(){s&&s.reset(),g&&g.reset()},C}var X;function ie(){return X||(X=se(null,{useWorker:!0,resize:!0})),X}function ye(a,e,r,i,l,c,u){var s=new Path2D(a),d=new Path2D;d.addPath(s,new DOMMatrix(e));var v=new Path2D;return v.addPath(d,new DOMMatrix([Math.cos(u)*l,Math.sin(u)*l,-Math.sin(u)*c,Math.cos(u)*c,r,i])),v}function xe(a){if(!N)throw new Error("path confetti are not supported in this browser");var e,r;typeof a=="string"?e=a:(e=a.path,r=a.matrix);var i=new Path2D(e),l=document.createElement("canvas"),c=l.getContext("2d");if(!r){for(var u=1e3,s=u,d=u,v=0,x=0,g,M,C=0;C<u;C+=2)for(var h=0;h<u;h+=2)c.isPointInPath(i,C,h,"nonzero")&&(s=Math.min(s,C),d=Math.min(d,h),v=Math.max(v,C),x=Math.max(x,h));g=v-s,M=x-d;var j=10,S=Math.min(j/g,j/M);r=[S,0,0,S,-Math.round(g/2+s)*S,-Math.round(M/2+d)*S]}return{type:"path",path:e,matrix:r}}function Me(a){var e,r=1,i="#000000",l='"Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", "EmojiOne Color", "Android Emoji", "Twemoji Mozilla", "system emoji", sans-serif';typeof a=="string"?e=a:(e=a.text,r="scalar"in a?a.scalar:r,l="fontFamily"in a?a.fontFamily:l,i="color"in a?a.color:i);var c=10*r,u=""+c+"px "+l,s=new OffscreenCanvas(c,c),d=s.getContext("2d");d.font=u;var v=d.measureText(e),x=Math.ceil(v.actualBoundingBoxRight+v.actualBoundingBoxLeft),g=Math.ceil(v.actualBoundingBoxAscent+v.actualBoundingBoxDescent),M=2,C=v.actualBoundingBoxLeft+M,h=v.actualBoundingBoxAscent+M;x+=M+M,g+=M+M,s=new OffscreenCanvas(x,g),d=s.getContext("2d"),d.font=u,d.fillStyle=i,d.fillText(e,C,h);var j=1/r;return{type:"bitmap",bitmap:s.transferToImageBitmap(),matrix:[j,0,0,j,-x*j/2,-g*j/2]}}n.exports=function(){return ie().apply(this,arguments)},n.exports.reset=function(){ie().reset()},n.exports.create=se,n.exports.shapeFromPath=xe,n.exports.shapeFromText=Me})(function(){return typeof window<"u"?window:typeof self<"u"?self:this||{}}(),ne,!1);const De=ne.exports;ne.exports.create;class We extends de.Component{constructor(n){super(n);ee(this,"refCanvas");ee(this,"confetti");this.refCanvas=de.createRef(),this.confetti=null}componentDidMount(){if(!this.refCanvas.current)return;const{resize:n,useWorker:m}=this.props,b={resize:typeof n>"u"?!0:n,useWorker:typeof m>"u"?!0:m};this.confetti=De.create(this.refCanvas.current,b),this.setRefConfetti()}componentDidUpdate(n){const{fire:m,reset:b}=this.props,P=!!m,N=m!==n.fire;P&&N&&this.fireConfetti();const w=!!b,k=b!==n.reset;w&&k&&this.resetConfetti()}componentWillUnmount(){this.unsetRefConfetti()}setRefConfetti(){const{refConfetti:n}=this.props;n&&n(this.confetti)}unsetRefConfetti(){const{refConfetti:n}=this.props;n&&n(null)}fireConfetti(){if(!this.confetti)return;const{onFire:n,onDecay:m,onReset:b,className:P,style:N,width:w,height:k,refConfetti:W,fire:z,reset:A,...F}=this.props;n&&n();const _=this.confetti(F);_&&_.then(()=>{m&&m()})}resetConfetti(){if(!this.confetti)return;this.confetti.reset();const{onReset:n}=this.props;n&&n()}render(){const{style:n,className:m,width:b,height:P}=this.props;return t.jsx("canvas",{ref:this.refCanvas,style:n,className:m,width:b,height:P})}}const ze={position:"fixed",pointerEvents:"none",width:"100%",height:"100%",top:0,left:0};function fe(p,o){return{particleCount:4,angle:p,spread:100,origin:{x:o},colors:["#1370B9","#ffffff"]}}function Ue({setStartAnim:p}){const o=I.useRef(null),[n,m]=I.useState(null),b=I.useCallback(k=>{o.current=k},[]),P=I.useCallback(()=>{o.current&&(o.current(fe(60,0)),o.current(fe(120,1)))},[]),N=I.useCallback(()=>{n||m(setInterval(P,16))},[P,n]),w=I.useCallback(()=>{clearInterval(n??0),m(null),o.current&&o.current.reset()},[n]);return I.useEffect(()=>{console.log("setStart"),p(()=>()=>{console.log("1"),N(),setTimeout(w,5e3)})},[]),I.useEffect(()=>()=>{clearInterval(n??0)},[n]),t.jsx(We,{refConfetti:b,style:ze})}const qe="_modalOverlay_g8ryl_1",Ve="_modalContent_g8ryl_14",Ze="_closeButton_g8ryl_23",He="_modalBody_g8ryl_33",te={modalOverlay:qe,modalContent:Ve,closeButton:Ze,modalBody:He},Ge=({isOpen:p,onClose:o,title:n,children:m})=>p?t.jsx("div",{className:te.modalOverlay,onClick:o,children:t.jsxs("div",{className:te.modalContent,onClick:b=>b.stopPropagation(),children:[t.jsx(E.Title,{as:"h2",className:"text-center",children:n}),t.jsx("div",{className:te.modalBody,children:m})]})}):null,ra=()=>{var q,V;const{id:p}=Fe(),{city:o}=Oe(f=>f.system),{isLoading:n,data:m,refetch:b}=ke({city:o,id:p}),[P,{isLoading:N}]=_e(),[w,k]=I.useState(null),[W]=Le(),[z,A]=I.useState(!1),[F,_]=I.useState({author:""}),[H,G]=I.useState(()=>{}),y=async()=>{if(((m==null?void 0:m.reviews.length)||0)<10){alert("Простите, невозможен анализ, так как слишком мало отзывов");return}try{if(m&&o&&p&&m.reviews.length!==0){const f=await P({city:o,related_id:Number(p),review_ids:m.reviews.slice(0,10).map(({id:T})=>T)}).unwrap();k(f)}}catch(f){console.log(f)}},Q=async f=>{f.preventDefault(),await W({...F,event_id:Number(p),city:o}),console.log("start Anim"),H(),await b(),A(!1)};if(n)return t.jsx(D,{className:"flex flex-1 justify-center items-center p-3",children:t.jsx(ae,{})});if(n)return t.jsx(D,{className:"flex flex-1 justify-center items-center p-3",children:t.jsx(ae,{})});if(!m)return t.jsx(D,{className:"flex flex-1 justify-center items-center p-3",children:t.jsx(E.Title,{as:"h3",children:"Простите, мероприятия нет"})});const{average_rating:$,name:U,number_of_reviews:J,reviews:K}=m;return t.jsxs(t.Fragment,{children:[t.jsx(Ue,{setStartAnim:G}),t.jsx(Ge,{onClose:()=>A(!1),isOpen:z,title:"Новый отзыв",children:t.jsxs("form",{className:"flex flex-col gap-2 p-2 mt-3",onSubmit:Q,children:[t.jsx(Z,{required:!0,label:"Автор",value:F.author,onChange:f=>_(T=>({...T,author:f.target.value}))}),t.jsx(Z,{label:"Плюсы",value:F.positive_comment,onChange:f=>_(T=>({...T,positive_comment:f.target.value}))}),t.jsx(Z,{label:"Минусы",value:F.negative_comment,onChange:f=>_(T=>({...T,aunegative_commentthor:f.target.value}))}),t.jsx(Z,{label:"Дополнительно",value:F.additionally,onChange:f=>_(T=>({...T,additionally:f.target.value}))}),t.jsx(he,{starClassname:"h-8 w-8",rating:F.rating||0,onStarClick:f=>_(T=>({...T,rating:f}))}),t.jsx(re,{variant:"large",className:"mt-2",children:"Отправить"})]})}),t.jsxs(D,{className:"flex flex-col gap-4 flex-1 p-3",children:[t.jsxs("div",{className:"flex flex-col gap-2",children:[t.jsx(E.Title,{as:"h3",children:U}),t.jsxs(E.Title,{as:"h4",children:["Средняя оценка: ",$]})]}),N?t.jsx("div",{className:"flex p-4 justify-center items-center",children:t.jsx(ae,{})}):w?t.jsxs("div",{className:"grid sm:grid-cols-[2fr_1fr] max-sm:grid-rows-2 gap-2 p-2 max-h-[90vh] min-h-[80vh]",children:[t.jsx("div",{className:"w-full",children:t.jsx(Be,{loading:N,data:(w==null?void 0:w.evaluation_criteria)||[]})}),t.jsxs(D,{variant:"white",className:"flex flex-col gap-2  rounded-lg p-3",children:[t.jsx(E.Title,{as:"h3",children:"Рекомендации"}),(V=(q=w==null?void 0:w.summary)==null?void 0:q.recommendations)!=null&&V.length?w.summary.recommendations.map(({text:f})=>t.jsx(D,{className:"p-2",children:f})):t.jsx(E.Paragraph,{children:"Рекомендации отсутствуют"})]})]}):t.jsx("div",{className:"flex p-4 justify-center items-center",children:t.jsx(re,{onClick:y,children:"Сгенерировать сводку"})}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex justify-between items-center my-2",children:[t.jsxs(E.Title,{className:"my-2",as:"h4",children:["Количество отзывов: ",J]}),t.jsx(re,{onClick:()=>A(!0),children:"Новый отзыв"})]}),t.jsx("div",{className:"flex flex-col gap-3",children:K.map(f=>t.jsxs(D,{variant:"white",className:"shadow-md rounded-md p-3 flex flex-col gap-2",children:[t.jsxs(E.Paragraph,{variant:"button",children:["Автор: ",f.author?f.author:"Отсутствует"]}),t.jsxs(E.Paragraph,{variant:"body",children:["Плюсы: ",f.positive_comment?f.positive_comment:"Отсутствует"]}),t.jsxs(E.Paragraph,{variant:"body",children:["Минусы: ",f.negative_comment?f.negative_comment:"Отсутствует"]}),t.jsxs(E.Paragraph,{variant:"caption",children:["Доп.: ",f.additionally?f.additionally:"Отсутствует"]}),t.jsx(he,{starClassname:"h-6 w-6",rating:f.rating})]}))})]})]})]})};export{ra as default};
